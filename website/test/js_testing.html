<!DOCTYPE html>
<!-- TODO:

    get api function
    make game code itself

    make guess code
    integrate with website
    design


-->
<html>
    <head>
        <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
        <style>
			#map {
			height: 65vh;
            width: 100%;
			}
		</style>
    </head>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        var selectionObject = {
		  "United States": {
				"10k-100k": ["mi", "km"],
				"100k-1M": ["mi", "km"],
				"1M+": ["mi", "km"]
          }
		}
		window.onload = function() {
		  var countrySel = document.getElementById("country");
		  var popSel = document.getElementById("pop");
		  var distSel = document.getElementById("distance");
		  for (var x in selectionObject) {
			countrySel.options[countrySel.options.length] = new Option(x, x);
		  }
		  countrySel.onchange = function() {
			//empty pops- dropdowns
			popSel.length = 1;
            distSel.length = 1;
			//display correct values
			// var y = selectionObject[countrySel.value]
			for (var y in selectionObject[this.value]) {
                popSel.options[popSel.options.length] = new Option(y, y);
            }
		  }
          popSel.onchange = function() {
            distSel.length = 1;
            // var z = selectionObject[popSel.value]
            var z = selectionObject[countrySel.value][this.value];
            for (var i = 0; i < z.length; i++) {
                distSel.options[distSel.options.length] = new Option(z[i], z[i]);
            }
          }

          

          

		
		}
    </script>


    <div id="map" height="40%" width="100%"></div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
        <script>
            // Function to initialize the map
            function initMap() {
            // Create the map
            var map = L.map('map').setView([38, -100], 4);

            // Add the tile layer (you can use any tile provider you prefer)
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors',
                // maxZoom: 4
                minZoom: 4
            }).addTo(map);

            return map;
            }

            // Function to add a marker to the map
            function addMarker(map, lat, lon) {
                var marker = L.marker([lat, lon]).addTo(map);
                // var marker = L.marker([lat, lon], { icon: redIcon }).addTo(map);
            }

            // Create a red icon for the marker
            var redIcon = L.icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
            iconSize: [10, 15],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            tooltipAnchor: [16, -28],
            shadowSize: [41, 41]
            });


    </script>
    

    <div class ="center">
        <div class="selection-bar">
            <!-- <form name="form1" id="form1" action="/action_page.php"> -->
                <div class="selBar">
                    Country: 
                </div>
                <div class="selBar">
                <select name="country" id="country">
                    <option value="" selected="selected">Select country</option>
                </select>
                </div>
                <div class="selBar">
                    Population Range: 
                </div>
                <div class="selBar">
                    <select name="pop" id="pop">
                    <option value="" selected="selected">Please Select Country First</option>	
                    </select>
                </div>
                <div class="selBar">
                    Units:
                </div>
                <div class = "selBar">
                    <select name="Dist" id="distance">
                        <option value="" selected="selected">Please Select Population First</option>
                    </select>
                </div>
                <div>
                    <button id="hard_mode" onclick="activate_hard_mode()">Hard Mode</button>    
                </div>
                <div class="selBar">
                <button id="start_game_play" onclick=start_game()>Play</button> 
                </div>
        </div>
    </div>

 
     
    <!-- <button onclick = "make_guess_table()">
        click here
    </button>

    <br><br>
     
    <br><br><br> -->

    <div>
        <table>
            <form>
            <tr>
            <td>
                <input id="city_guess" type="text" style="width: 447px" />   
            </td>
            <td>
                <input id="Guess_button" type="submit" value="Guess" onclick="return guess_button_onclick()" /></td>
            </tr>
            </form>
        </table>

        <p id="most_recent_guess"></p>
        <table id="guess_table" align = "center" border="1px"></table>
        

        <input id="answer" type="button" value="Give Up?" onclick="return game.get_answer.call(game)">
        <input id="reset" type="button" value="Play Again?" onclick="return reset()">
    </div>

    <script>

        function start_game(){
            act_dict = get_initial_city()
            game.add_actual_dict(act_dict)
        }
        function get_initial_city(){
            var starting_country = game._countrySel
            var starting_range = game._popSel
            



            // TODO set values
            var base_pop = 0
            var multiple = 20000
            var rand_num = 0

            var looking_for_city = true
            while( looking_for_city == true){
                if (starting_range == 'tenk'){
                    base_pop = 10000
                    multiple = 20000
                    // TODO: have to update random number
                    rand_num = getRandomInt(45)
                }
                else if (starting_range == 'hundredk'){
                    base_pop = 100000
                    multiple = 20000
                    rand_num = getRandomInt(45)
                }
                else if (starting_range == 'onemil'){
                    base_pop = 1000000
                    multiple = 20000
                    rand_num = getRandomInt(235)
                }

                var min_pop = base_pop + multiple * rand_num
                var max_pop = min_pop + multiple
                // TODO: change country
                var api_url = 'https://api.api-ninjas.com/v1/city?country=US&min_population=' + min_pop + '&max_population=' + max_pop + '&limit=1';

                

                

                // API call. If fails goes back to start of loop
                response_dict = get_api_call(api_url)


                if (response_dict == 'api_call_failed' || response_dict == undefined) {
                    continue
                }

                // If successful breaks loop
                looking_for_city = false
                return response_dict
            
            }
            
        }

        function getRandomInt(max) {
            return Math.floor(Math.random() * max);
        }


        function get_api_call(api_url){

            // have to make and update global variable
            var response_dict
            function updateResult(data) {
                response_dict = data[0];
            }

            // gets dictionary object if api successful
            try{
                $.ajax({
                    method: 'GET',
                    url: api_url,
                    headers: { 'X-Api-Key': '1/IM/Lmf6TebQhklcoTpiQ==sHCkkzz1m4vHjTJR'},
                    contentType: 'application/json',
                    async: !1,
                    success: function(result) {
                        // if successful updates here
                        updateResult(result)
                        console.log(result);
                    },
                    error: function ajaxError(jqXHR) {
                        console.error('Error: ', jqXHR.responseText);
                    }
                });
            }
            catch{
                // failed
                return "api_call_failed"
            }

            return response_dict
        }


        function get_lat_lon(api_dict, type){
            if (type == 'lat'){
                return api_dict['latitude']
            }
            else if (type == 'lon'){
                return api_dict['longitude']
            }
        }

        function calcDist(lat1, lon1, lat2, lon2, unit) {
            // TODO: add miles/kilo filter
            if ((lat1 == lat2) && (lon1 == lon2)) {
                return 0;
            }
            else {
                var radlat1 = Math.PI * lat1/180;
                var radlat2 = Math.PI * lat2/180;
                var theta = lon1-lon2;
                var radtheta = Math.PI * theta/180;
                var dist = Math.sin(radlat1) * Math.sin(radlat2) + Math.cos(radlat1) * Math.cos(radlat2) * Math.cos(radtheta);
                if (dist > 1) {
                    dist = 1;
                }
                dist = Math.acos(dist);
                dist = dist * 180/Math.PI;
                dist = dist * 60 * 1.1515;
                if (unit=="K") { dist = dist * 1.609344 }
                if (unit=="N") { dist = dist * 0.8684 }
                return Math.round(dist);
            }
        }

        function activate_hard_mode(){
            hard_mode_button = document.getElementById("hard_mode")

            
            if (hard_mode_button.innerHTML == "Hard Mode" || hard_mode_button.innerHTML == "Activate Hard Mode"){
                game._hard_mode = true;
                hard_mode_button.innerHTML = "Deactivate Hard Mode"
            }
            else if (hard_mode_button.innerHTML == "Deactivate Hard Mode"){
                game._hard_mode = false;
                hard_mode_button.innerHTML = "Activate Hard Mode"
            }
            
            
            
        }

        function guess_button_onclick(){
            act_dict = game.return_answer.call(game)
            guess_dict = validate_guess()
            document.getElementById('city_guess').value = "";

            if (guess_dict == 'api_call_failed' || guess_dict == undefined) {
                alert('Try again. Check Spelling')
                return false
            }


            
            act_name = act_dict['name']
            guess_name = guess_dict['name']

            act_lat = get_lat_lon(act_dict, "lat")
            act_lon = get_lat_lon(act_dict, "lon")
            guess_lat = get_lat_lon(guess_dict, "lat")
            guess_lon = get_lat_lon(guess_dict, "lon")

            
            _winner = check_if_answer(act_dict, guess_dict)
            if (_winner){
                winner()
            }
            var dist_units = "M"
            if (game._distSel == "mi"){
                dist_units = "M"
            }
            else if (game._distSel == "km"){
                dist_units = "K"
            }

            alert("dist unit = " + dist_units)

            distance = calcDist(act_lat, act_lon, guess_lat, guess_lon, dist_units)

            display_most_recent_guess(guess_name, distance)


            game.add_guesses_dict(guess_name, distance)
            guesses_dict = game.return_guesses_dict.call(game)

            str = JSON.stringify(guesses_dict);
            // alert(str)

            var sorted_guesses_list = Object.keys(guesses_dict).map(function(key) {
                return [key, guesses_dict[key]];
            });

            // Sort the array based on the second element
            sorted_guesses_list.sort(function(first, second) {
                return first[1] - second[1];
            });




            make_guess_table(sorted_guesses_list)

            // TODO: Integrate other code

            // add marker to map
            addMarker(game._map, guess_lat, guess_lon);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
            
            return false

            
        }

        function validate_guess(){
            var city_guess = document.getElementById("city_guess").value;
            var api_url = "https://api.api-ninjas.com/v1/city?country=US&name=" + city_guess

            return get_api_call(api_url)
        }

        function check_if_answer(act_dict, guess_dict){
            return (act_dict['name'] == guess_dict['name'])
        }

        function display_most_recent_guess(guess_name, distance){
            var most_recent_guess = document.getElementById("most_recent_guess");
            most_recent_guess.innerHTML = "Last Guess: " + guess_name + " " + distance;

            // var cols = [];
            // cols.push(guess_name);
            
            // var table = document.createElement("table");
            // var tr = table.insertRow(-1);

            // // most_recent_guess.innerHTML = "";
            // guess_list = ["Last Guess: ", guess_name, distance]
                 
            // // Create a new row
            // trow = table.insertRow(-1);
            // // for (var i = 0; i < guess_list.length; i++) {
            //     var cell = trow.insertCell(-1);
                
            //     // Inserting the cell at particular place
            //     cell.innerHTML = "Last Guess: " + guess_name + " " + distance;
            // // }
            
            
            // most_recent_guess.appendChild(table);

        }

        function make_guess_table(sorted_guesses_list) {
            var cols = [];
             
            for (var i = 0; i < sorted_guesses_list.length; i++) {
                for (var k in sorted_guesses_list[i]) {
                    if (cols.indexOf(k) === -1) {
                        // Push all keys to the array
                        cols.push(k);
                    }
                }
            }
             
            // Create a table element
            var table = document.createElement("table");
             
            // Create table row tr element of a table
            var tr = table.insertRow(-1);
             
            table_headers = ["City", "Distance"]
            for (var i = 0; i < table_headers.length; i++) {
                 
                // Create the table header th element
                var theader = document.createElement("th");
                theader.innerHTML = table_headers[i];
                 
                // Append columnName to the table row
                tr.appendChild(theader);
            }
             
            // Adding the data to the table
            for (var i = 0; i < sorted_guesses_list.length; i++) {
                 
                // Create a new row
                trow = table.insertRow(-1);
                for (var j = 0; j < cols.length; j++) {
                    var cell = trow.insertCell(-1);
                     
                    // Inserting the cell at particular place
                    cell.innerHTML = sorted_guesses_list[i][cols[j]];
                }
            }
             
            // Add the newly created table containing json data
            var el = document.getElementById("guess_table");
            el.innerHTML = "";
            el.appendChild(table);
        }   

        function winner(){
            // TODO: make winner page
            alert('YOU WINNNN answer was ' + act_dict['name'])
        }

        function reset(){
            window.location.reload();
        }


        function game_class(map) {
            // Attributes
            this._act_dict;
            this._guesses_dict = {};
            this._map = map;
            this._hard_mode = false;
            this._popSel;
            this._countrySel;
            this._distSel;

            this.add_actual_dict = function(act_dict){
                this._act_dict = act_dict
            }
            
            // Methods
            this.get_answer = function(){
                // TODO: make play again page
                alert("Answer was: " + this._act_dict['name'])
                return this._act_dict
            }

            this.return_answer = function(){
                return this._act_dict
            }

            this.add_guesses_dict = function(key, value){
                this._guesses_dict[key] = value                
            }

            this.return_guesses_dict = function(){
                return this._guesses_dict
            }

            this.reset_guesses_dict = function(){
                this._guesses_dict = {}
            }
        }
        

        // MAIN CODE
        // Initialize the map
        var map = initMap();


        // act_dict = get_initial_city("hundredk")
        game = new game_class(map)
        

        // str = JSON.stringify(act_d);

        // Example usage to add a marker
        // var latitude = 40.7306;  // Latitude of the point
        // var longitude = -73.9352; // Longitude of the point
        // addMarker(game._map, latitude, longitude);
        
         
        
    </script>
    
</html>
